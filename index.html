<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>WebRTC with WebSocket</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <style>
        body {
            width: 800px;
            margin: 0 auto;
        }
        #videos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 1em;
            width: 100%;
            padding: 10px;
        }
        video {
            width: 100%;
            border: 2px solid greenyellow;
            background-color: rgb(63, 62, 62);
        }
        textarea {
            height: 50px;
            width: 100%;
        }
        .step {
            background-color: beige;
            padding: 10px;
            margin: 10px;
        }
        .step p {
            margin: 0;
        }
        @media screen and (max-width: 800px) {
            body {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="videos">
        <video class="video-player" id="user-1" autoplay playsinline></video>
        <video class="video-player" id="user-2" autoplay playsinline></video>
    </div>

    <div class="step">
        <p><strong>Step 1:</strong> User 1, click "Create offer" to generate SDP offer and copy offer from the text area below.</p>
        <button id="create-offer">Create Offer</button>
    </div>

    <label>SDP OFFER:</label>
    <textarea id="offer-sdp" placeholder='User 2, paste SDP offer here...'></textarea>

    <div class="step">
        <p><strong>Step 2:</strong> User 2, paste SDP offer generated by User 1 into the text area above, then click "Create Answer" to generate SDP answer and copy the answer from the text area below.</p>
        <button id="create-answer">Create Answer</button>
    </div>

    <label>SDP Answer:</label>
    <textarea id="answer-sdp" placeholder="User 1, paste SDP answer here..."></textarea>

    <div class="step">
        <p><strong>Step 3:</strong> User 1, paste SDP offer generated by User 2 into the text area above and then click "Add Answer"</p>
        <button id="add-answer">Add Answer</button>
    </div>

    <script>
        let peerConnection = new RTCPeerConnection();
        let localStream;
        let remoteStream;
        let clientId = Math.floor(Math.random() * 10000).toString();
        let targetId = '';

        let ws = new WebSocket('ws://yourdomain.com:8080'); // Update this with your domain

        ws.onopen = () => {
            ws.send(JSON.stringify({ type: 'register', clientId: clientId }));
        };

        ws.onmessage = (message) => {
            let data = JSON.parse(message.data);

            switch(data.type) {
                case 'offer':
                    document.getElementById('offer-sdp').value = data.sdp;
                    targetId = data.clientId;
                    break;
                case 'answer':
                    document.getElementById('answer-sdp').value = data.sdp;
                    targetId = data.clientId;
                    break;
                case 'candidate':
                    peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                    break;
            }
        };

        let init = async () => {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            remoteStream = new MediaStream();
            document.getElementById('user-1').srcObject = localStream;
            document.getElementById('user-2').srcObject = remoteStream;

            localStream.getTracks().forEach((track) => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.ontrack = (event) => {
                event.streams[0].getTracks().forEach((track) => {
                    remoteStream.addTrack(track);
                });
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, clientId: clientId, targetId: targetId }));
                }
            };
        };

        let createOffer = async () => {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp, clientId: clientId }));
        };

        let createAnswer = async () => {
            let offer = JSON.parse(document.getElementById('offer-sdp').value);

            await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: offer }));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp, clientId: clientId, targetId: targetId }));
        };

        let addAnswer = async () => {
            let answer = JSON.parse(document.getElementById('answer-sdp').value);

            if (!peerConnection.currentRemoteDescription) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answer }));
            }
        };

        init();

        document.getElementById('create-offer').addEventListener('click', createOffer);
        document.getElementById('create-answer').addEventListener('click', createAnswer);
        document.getElementById('add-answer').addEventListener('click', addAnswer);
    </script>
</body>
</html>
